<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="description" content="">


    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>6. Flash &amp; Test MCU :: Connected Drink Dispenser Workshop</title>

    
    <link href="../../css/nucleus.css" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css" rel="stylesheet">
    <link href="../../css/hybrid.css" rel="stylesheet">
    <link href="../../css/featherlight.min.css" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../../css/auto-complete.css" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="../../css/theme.css" rel="stylesheet">
    <link href="../../css/hugo-theme.css" rel="stylesheet">
    
      <link href="../../css/theme-mine.css" rel="stylesheet">
    

    <script src="../../js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    <link rel="stylesheet" href="../../css/adoc.css">
<link rel="stylesheet" href="../../css/tags.css">
<link rel="stylesheet" href="../../css/jquery-ui.min.css">
  </head>
  <body class="" data-url="/participant/lab_modules/6_flash_and_test.html">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://cdd.example.com/docs/docs">
    <img src="../../images/cdd_logo.png" alt="Connected Drink Dispenser Workshop" width="50%">
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js"></script>
<script type="text/javascript" src="../../js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/cdd.example.com\/docs";
    
</script>
<script type="text/javascript" src="../../js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/participant.html" title="Workshop Participant" class="dd-item 
        parent
        
        
        ">
      <a href="../../participant.html">
          <i class="fas fa-user-graduate"></i>&nbsp;Workshop Participant
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules.html" title="Lab Modules" class="dd-item 
        parent
        
        
        ">
      <a href="../../participant/lab_modules.html">
          <i class="fas fa-user-graduate"></i>&nbsp;Lab Modules
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/1_overview.html" title="1. Architecture Overview" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/1_overview.html">
          1. Architecture Overview
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/2_laptop_setup.html" title="2. Laptop Setup" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/2_laptop_setup.html">
          2. Laptop Setup
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/3_create_account.html" title="3. Create Account/Resources" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/3_create_account.html">
          3. Create Account/Resources
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/4_esp_setup.html" title="4. MCU Setup &amp; Test" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/4_esp_setup.html">
          4. MCU Setup &amp; Test
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/5_cloud9_setup.html" title="5. Cloud9 Development Environment" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/5_cloud9_setup.html">
          5. Cloud9 Development Environment
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/6_flash_and_test.html" title="6. Flash &amp; Test MCU" class="dd-item 
        parent
        active
        
        ">
      <a href="../../participant/lab_modules/6_flash_and_test.html">
          6. Flash &amp; Test MCU
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/7_investigate_cloud.html" title="7. Review Cloud Architecture" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/7_investigate_cloud.html">
          7. Review Cloud Architecture
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/8_build_dispenser.html" title="8. Build Dispenser" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/8_build_dispenser.html">
          8. Build Dispenser
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/9_final_test.html" title="9. Dispense a Drink!" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/9_final_test.html">
          9. Dispense a Drink!
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/presenter.html" title="Setting Up the Workshop" class="dd-item 
        
        
        
        ">
      <a href="../../presenter.html">
          <i class="fas fa-chalkboard-teacher"></i>&nbsp;Setting Up the Workshop
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/presenter/prerequisites.html" title="Prerequisites" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/prerequisites.html">
          <i class="fas fa-greater-than"></i>&nbsp;Prerequisites
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/deploy.html" title="Deploy Stack" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/deploy.html">
          <i class="fas fa-greater-than"></i>&nbsp;Deploy Stack
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/repository.html" title="Repository Layout" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/repository.html">
          <i class="fas fa-greater-than"></i>&nbsp;Repository Layout
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/design_notes.html" title="Design Notes" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/design_notes.html">
          <i class="fas fa-greater-than"></i>&nbsp;Design Notes
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/presenter/design_notes/message_flows.html" title="Message Flows" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/design_notes/message_flows.html">
          <i class="fas fa-greater-than"></i>&nbsp;Message Flows
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/search?q=topic%3Aiot&#43;org%3Aaws-samples&#43;fork%3Atrue"><i class='fas fa-bookmark'></i> AWS Samples on GitHub</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='../../'></a> > <a href='../../participant.html'>Workshop Participant</a> > <a href='../../participant/lab_modules.html'>Lab Modules</a> > 6. Flash & Test MCU
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#objectives">Objectives</a></li>
<li><a href="#steps-to-complete">Steps to Complete</a>
<ul>
<li><a href="#modify-the-source-files-for-your-dispenser">Modify the Source Files for Your Dispenser</a></li>
<li><a href="#compile-and-download-the-code-from-cloud9">Compile and Download the Code from Cloud9</a></li>
<li><a href="#flash-and-monitor-the-microcontroller-from-your-laptop">Flash and Monitor the Microcontroller from Your Laptop</a></li>
</ul></li>
<li><a href="#checkpoints">Checkpoints</a></li>
<li><a href="#optional-outcomes">(optional) Outcomes</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              6. Flash &amp; Test MCU
            </h1>
          

        




	

<h2 id="objectives">Objectives</h2>

<p>In this lab module, you will complete the configuration of the dispenser firmware, download the compiled files to your laptop, and then use the tools to flash the microcontroller. At that point, the main components of the dispenser with the exception of the motor, will be fully operational. By the end of the module you will have:</p>

<ul>
<li>Modified the base firmware code to work with your specific account.</li>
<li>Compiled and downloaded the code files to your laptop.</li>
<li>Flashed the microcontroller with the compiled code on your laptop.</li>
<li>Verified it is communicating with AWS IoT by turning on and off the LED.</li>
</ul>

<h2 id="steps-to-complete">Steps to Complete</h2>

<p>Follow each step in order and use the <em>Open for detailed step-by-step instructions</em> if required.</p>

<h3 id="modify-the-source-files-for-your-dispenser">Modify the Source Files for Your Dispenser</h3>

<p>The X.509 client certificate and private key you downloaded earlier to your laptop&rsquo;s <code>cdd</code> directory uniquely identify your dispenser from all others. In order to communicate to AWS IoT core, you need to modify two of the source files in Cloud9 with the following in <code>device_firmware/demos/include</code>:</p>

<table>
<thead>
<tr>
<th>Firmware Source File</th>
<th><code>#define</code> Statement in File</th>
<th>Content</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>aws_clientcredential.h</code></td>
<td>clientcredentialMQTT_BROKER_ENDPOINT</td>
<td>AWS IoT Endpoint value from <em>MY DETAILS</em> section of webapp</td>
</tr>

<tr>
<td><code>aws_clientcredential.h</code></td>
<td>clientcredentialIOT_THING_NAME</td>
<td>Your assigned dispenser name (3-digit number) to use when connecting to the MQTT broker</td>
</tr>

<tr>
<td><code>aws_clientcredential.h</code></td>
<td>clientcredentialWIFI_SSID</td>
<td>WiFi network name provided by workshop presenter</td>
</tr>

<tr>
<td><code>aws_clientcredential.h</code></td>
<td>clientcredentialWIFI_PASSWORD</td>
<td>Provided password for the WiFi network</td>
</tr>

<tr>
<td><code>aws_clientcredential_keys.h</code></td>
<td>keyCLIENT_CERTIFICATE_PEM</td>
<td>Converted X.509 certificate (<code>nnn-certificate.pem.crt</code>)  content from <a href="https://cdd.baah.io/cred_formatter/index.html" target="_blank">Credential Formatter</a></td>
</tr>

<tr>
<td><code>aws_clientcredential_keys.h</code></td>
<td>keyCLIENT_PRIVATE_KEY_PEM</td>
<td>Converted certificate private key <code>nnn-private.pem.key</code>  content from <a href="https://cdd.baah.io/cred_formatter/index.html" target="_blank">Credential Formatter</a></td>
</tr>
</tbody>
</table>

<p>In Cloud9, navigate to the <code>device_firmware/demos/include</code> folder, then double-click on the two files above and modify the contents. The output for the last two PEM files in <code>aws_clientcredential_keys.h</code>, when copied over should look similar to this before and after (certifcate only, do the same with private key):</p>

<p><strong>BEFORE</strong>:</p>

<pre><code>#define keyCLIENT_CERTIFICATE_PEM                   &quot;REPLACE_WITH_CONVERTED_CERTIFICATE_STRING&quot;
</code></pre>

<p><strong>AFTER</strong>:</p>

<pre><code>#define keyCLIENT_CERTIFICATE_PEM                   &quot;-----BEGIN CERTIFICATE-----\n&quot;\
&quot;MIICxjCCAa6gAwIBAgIVAJhkG3c6wT05SEZKJ3OsVHrQov6nMA0GCSqGSIb3DQEB\n&quot;\
...
&quot;IdbvOv7LLT9BD2Z8Mx9H/BhCd9ylpZEyQcl948GjEXgBDGdxUKFhrEfx\n&quot;\
&quot;-----END CERTIFICATE-----&quot; 
</code></pre>

<p>Once both files are modified, save them in the Cloud9 IDE, but leave them open to make changes if needed later.</p>


<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	Open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <ol>
<li><p>In Cloud9, navigate to the <code>device_firmware/demos/include</code> folder then double-click the two source files to modify:</p>

<p><img src="../../images/lab6_c9_includes.png" alt="Source file to update" /></p></li>

<li><p>In each file reference above, replace the contents between the double-quotes. All values you need to replace start with <code>&quot;REPLACE_WITH_...&quot;</code>. Here are examples of what the WiFi and Certificate values should look like when done:</p>

<p><strong>BEFORE</strong>:
<img src="../../images/lab6_c9_mod_before.png" alt="Source files before update" /></p>

<p><strong>AFTER</strong>:
<img src="../../images/lab6_c9_mod_after.png" alt="Source files after update" /></p></li>
</ol>

<div class="notices note" ><p>The WiFi SSID must be entered exactly as given. Also, for the certificate and private key entries make sure the <code>---BEGIN</code> and <code>---END</code> look exactly as above. The data will be different and the private key will only be a few lines long as it is an ECC key.</p>
</div>

<ol>
<li>For each file, click the tab the from the Cloud9 menu, save both files (<em>File-&gt;Save</em>). Leave both files open as it will be easier to correct and potential errors.</li>
</ol>

    </div>
</div>

<h3 id="compile-and-download-the-code-from-cloud9">Compile and Download the Code from Cloud9</h3>

<p>With the updated files save, click on the terminal window where you did the compile steps in the previous lab. Run the <code>make</code> command again which will pick up the file changes and compile the firmware.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd ~/environment/connected-drink-dispenser-workshop/device_firmware/build
make all -j4</code></pre></div>
<p>Navigate in the Cloud9 file browser and open the <code>connected-drink-dispenser-workshop/device_firmware/build</code> folder. Scroll down and right-click on <code>aws_demos.bin</code> and select <em>Download</em> and save to your <code>cdd</code> directory. Do the same for the <code>build/bootloader/bootloader.bin</code> and <code>build/partition_table/partition_table.bin</code> files.</p>

<p>In your laptop&rsquo;s <code>cdd</code> directory you should have these three files.</p>


<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	Open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <ol>
<li><p>In Cloud9, click on the terminal window and rebuild the device firmware.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd ~/environment/connected-drink-dispenser-workshop/device_firmware/build
make all -j4</code></pre></div>
<p><img src="../../images/lab6_c9_build.png" alt="Update firmware build" /></p></li>

<li><p>Right-click on <code>aws_demos.bin</code>, select <em>Download</em>, and save the file to your <code>cdd</code> directory. Do the same in the <code>bootloader</code> folder for <code>bootloader.bin</code>, and in <code>partition_table</code> for <code>partition-table.bin</code>.</p>

<p><img src="../../images/lab6_c9_download.png" alt="Download firmware" /></p></li>

<li><p>When completed, make sure that <code>aws_demos.bin</code>, <code>bootloader.bin</code>, and <code>partition_table</code> are saved and available in your laptop&rsquo;s <code>cdd</code> directory.</p></li>
</ol>

    </div>
</div>

<h3 id="flash-and-monitor-the-microcontroller-from-your-laptop">Flash and Monitor the Microcontroller from Your Laptop</h3>

<p>Short description of what to do for experienced people</p>


<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	Open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <p>detailed steps with markdown.</p>

    </div>
</div>

<h2 id="checkpoints">Checkpoints</h2>

<p>Please ensure the following checkpoints are validated before moving on to the next module.</p>

<h2 id="optional-outcomes">(optional) Outcomes</h2>

<p>Lead off with something like &ldquo;so why did we do x, y, and z?</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../participant/lab_modules/5_cloud9_setup.html" title="5. Cloud9 Development Environment"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../participant/lab_modules/7_investigate_cloud.html" title="7. Review Cloud Architecture" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js"></script>
    <script src="../../js/perfect-scrollbar.min.js"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js"></script>
    <script src="../../js/jquery.sticky.js"></script>
    <script src="../../js/featherlight.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js"></script>
    <script src="../../js/learn.js"></script>
    <script src="../../js/hugo-learn.js"></script>

    <link href="../../mermaid/mermaid.css" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <div style="float: right;margin-right: 10px;margin-top: 10px;font-size: smaller;">Copyright © 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div>

<script src="../../js/fix-adoc.js"></script>
<script src="../../js/jquery-ui.min.js"></script>

  </body>
</html>
